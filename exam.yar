import "pe"

rule exam_Stage1
 {
	
     strings:
	 	// d'abord flag tout ce qui est HttpRequest et Process
        $a = "WriteProcessMemory"
		$b = "TerminateProcess"
		$c = "GetComputerNameW"
		$d = "GetComputerNameW"
		$e = "WinHttpOpen"
		$f = "WinHttpConnect"
		$g = "WinHttpOpenRequest"
		$h = "WinHttpSendRequest"
		$i = "WinHttpQueryDataAvailable"
		$j = "WinHttpReadData"
		$k = "WinHttpCloseHandle"

		// Ca c'est suspect de fou mais pas suffisant
		$ker = "KERNEL32.DLL" nocase
		$user = "USER32.DLL" nocase
		$win = "WINHTTP.dll" nocase

		// flag l'anti-debug
		$ida = "IDA" nocase
		$debug = "IsDebuggerPresent"
		$enum = "EnumWindows"
		$text = "GetWindowTextA"
		$class = "GetClassNameA"

		// La j'essaye de flag les 4 hash de la request et le hash du path
		$url_hash = { DA A2 C3 A2 CF A2 8C A2 CC A2 CD A2 C4 A2 CB A2 DA A2 8C A2 D0 A2 C7 A2 A2 A2 00 00 00 00}
		$agent_hash = {CB A2 CC A2 EA A2  F6 A2 F6 A2 F2 A2 82 A2 E7 A2 EC A2 F1 A2 EB A2 E0 A2 E4 A2 8D A2 93 A2 8C A2 92 A2 A2 A2 00 00}
		$object_hash = {8C A2 C7 A2 DA A2 C7 A2 A2 A2 00 00 00 00}
		$verb_hash = {E7 A2 F6 A2 A2 A2}
		$calc_hash = {FE A2 FE A2  D5 A2 CB A2 CC A2 C6 A2 CD A2 D5 A2 D1 A2 FE A2 FE A2 D1 A2 DB A2 D1 A2 D6 A2 C7 A2 CF A2 91 A2 90 A2 FE A2 FE A2 C1 A2C3 A2 CE A2 C1 A2 8C A2 C7 A2 DA A2 C7 A2 A2 A2}
         
     condition:
        all of them and pe.is_pe and filesize < 2MB 
 }